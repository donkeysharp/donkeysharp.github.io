<!DOCTYPE html>
<html lang="es">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Sergio Guillen Mantilla">
<meta name="description" content="El otro d√≠a cenando con mi amigo Francisco, √©l me comentaba que tiene un proyecto personal en mente y lo que desea conseguir. Escuchando sus preguntas la primera herramienta que pas√≥ por mi cabeza para resolver algunos de sus problemas fue utilizar OpenSSH.
Esta entrada la hago principalmente para mi amigo Francisco pero la redactar√© de forma general para que el benficio sea general.
Qu√© es SSH? SSH significa Secure Shell y es un protocolo para administrar servicios en una red mediante un canal cifrado (he ah√≠ el porqu√© de &ldquo;Secure&rdquo; üòâ).">

<meta property="og:title" content="Diversi√≥n con SSH - Local Port Forwarding" />
<meta property="og:description" content="El otro d√≠a cenando con mi amigo Francisco, √©l me comentaba que tiene un proyecto personal en mente y lo que desea conseguir. Escuchando sus preguntas la primera herramienta que pas√≥ por mi cabeza para resolver algunos de sus problemas fue utilizar OpenSSH.
Esta entrada la hago principalmente para mi amigo Francisco pero la redactar√© de forma general para que el benficio sea general.
Qu√© es SSH? SSH significa Secure Shell y es un protocolo para administrar servicios en una red mediante un canal cifrado (he ah√≠ el porqu√© de &ldquo;Secure&rdquo; üòâ)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.donkeysharp.xyz/blog/diversi%C3%B3n-con-ssh-local-port-forwarding/" />
<meta property="article:published_time" content="2018-08-28T08:30:57-04:00"/>
<meta property="article:modified_time" content="2018-08-28T08:30:57-04:00"/>


<title>


     Diversi√≥n con SSH - Local Port Forwarding 

</title>
<link rel="canonical" href="https://blog.donkeysharp.xyz/blog/diversi%C3%B3n-con-ssh-local-port-forwarding/">










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    
    <link rel="stylesheet" href="https://blog.donkeysharp.xyz/css/reset.css?t=2019-12-17%2014%3a23%3a00.071697243%20-0400%20-04%20m%3d%2b0.053836500">
    <link rel="stylesheet" href="https://blog.donkeysharp.xyz/css/pygments.css?t=2019-12-17%2014%3a23%3a00.071697243%20-0400%20-04%20m%3d%2b0.053836500">
    <link rel="stylesheet" href="https://blog.donkeysharp.xyz/css/main.css?t=2019-12-17%2014%3a23%3a00.071697243%20-0400%20-04%20m%3d%2b0.053836500">
    
        <link rel="stylesheet" href="https://blog.donkeysharp.xyz/css/override.css?t=2019-12-17%2014%3a23%3a00.071697243%20-0400%20-04%20m%3d%2b0.053836500">
    
        <link rel="stylesheet" href="https://blog.donkeysharp.xyz/css/monokai.css?t=2019-12-17%2014%3a23%3a00.071697243%20-0400%20-04%20m%3d%2b0.053836500">
    




<link rel="shortcut icon"

    href="https://blog.donkeysharp.xyz/img/leaf.ico"

>








</head>


<body lang="es">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                
                <a href="https://blog.donkeysharp.xyz/"><img class="avatar" src="https://blog.donkeysharp.xyz/img/donkeysharp.png" srcset="https://blog.donkeysharp.xyz/img/donkeysharp.png 1x"></a>
            
            <a href="https://blog.donkeysharp.xyz/"><div class="name">Sergio Guillen Mantilla</div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-blog"><a href="https://blog.donkeysharp.xyz/blog/"><span>{ Blog }</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/donkeysharp" target="_blank" rel="noopener"><img class="icon" src="https://blog.donkeysharp.xyz/img/github.svg" alt="github" /></a>
        

        
            <a href="//twitter.com/donkeysharp" target="_blank" rel="noopener"><img class="icon" src="https://blog.donkeysharp.xyz/img/twitter.svg" alt="twitter" /></a>
        

        

        

        

        

        
            <a href="//instagram.com/donkeysharp" target="_blank" rel="noopener"><img class="icon" src="https://blog.donkeysharp.xyz/img/instagram.svg" alt="instagram" /></a>
        

        

        

        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Diversi√≥n con SSH - Local Port Forwarding

</div>

                    <div class="initials"><a href="https://blog.donkeysharp.xyz">ad</a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='Tue Aug 28 2018 08:30:57 -04'>Aug 28, 2018</div>
                    
                    
                </div>
            </div>
            <div class="markdown">
                

<p>El otro d√≠a cenando con mi amigo Francisco, √©l me comentaba que tiene un proyecto personal en mente y lo que desea conseguir. Escuchando sus preguntas la primera herramienta que pas√≥ por mi cabeza para resolver algunos de sus problemas fue utilizar OpenSSH.</p>

<p>Esta entrada la hago principalmente para mi amigo Francisco pero la redactar√© de forma general para que el benficio sea general.</p>

<h2 id="qu√©-es-ssh">Qu√© es SSH?</h2>

<p><a href="https://es.wikipedia.org/wiki/Secure_Shell" target="_blank">SSH</a> significa Secure Shell y es un protocolo para administrar servicios en una red mediante un canal cifrado (he ah√≠ el porqu√© de &ldquo;Secure&rdquo; üòâ). Algunas de las tareas m√°s comunes que se pueden realizar con este protocolo es la de poder iniciar sesi√≥n en un servidor o la ejecuci√≥n remota de comandos.</p>

<p>Al ser SSH solamente un protocolo necesitamos una herramienta que implemente dicho protocolo. La m√°s utilizada es <a href="https://es.wikipedia.org/wiki/OpenSSH" target="_blank">OpenSSH</a> y es la herramienta que utilizaremos para esta gu√≠a. OpenSSH u otras implementaciones vienen por defecto en sistemas Unix-like (OSX, OpenBSD, FreeBSD, Linux, etc.) y en el caso de Windows personalmente yo instalo <a href="https://git-scm.com/downloads" target="_blank">Git Bash</a> ya que es una terminal Unix-like en Windows. Otros prefieren utilizar PuTTY.</p>

<h2 id="ensuciandonos-las-manos">Ensuciandonos las manos</h2>

<p>Para esta gu√≠a si bien podr√≠amos probarlo con una m√°quina virtual o una PC con Linux instalada en una red local o incluso en la misma m√°quina local, prefiero hacerlo en un entorno un poco m√°s real para probar mi punto, es por eso que crear√© un servidor p√∫blico.</p>

<h3 id="creando-un-servidor-p√∫blico">Creando un servidor p√∫blico</h3>

<blockquote>
<p><strong>Importante</strong> Si bien en esta secci√≥n utilizo DigitalOcean, pueden utilizar cualquier servidor p√∫blico que probablemente tengan u otros cloud providers e.g. <a href="https://aws.amazon.com/free" target="_blank">AWS</a>, <a href="https://www.vultr.com/promo25b?service=promo25b" target="_blank">Vultr</a>, <a href="https://welcome.linode.com/" target="_blank">Linode</a>, etc. La idea es tener un servidor que pueda ser accedido desde internet.</p>
</blockquote>

<p>Para esto voy a utilizar el cloud provider DigitalOcean que adem√°s de vender servidor virtuales p√∫blicos y otros servicios, este tiene una pol√≠tica de cobrar por hora, es decir que una m√°quina que nos costar√≠a 5 USD al mes si la tenemos corriendo todo el tiempo, pero si la utilizamos solo un par de horas, nos costar√° aproximadamente entre 0.007 a 0.014 centavos de USD. Pueden ver los precios en esta <a href="https://www.digitalocean.com/pricing/" target="_blank">p√°gina</a>.</p>

<p>El proceso de creaci√≥n de un servidor en DigitalOcean es bastante simple, solo un par de clicks y saber elegir la distribuci√≥n Linux y la cantidad de recursos a asignar. Yo elegir√© Debian 9 x64 con 1GB de memoria y me costar√° 0.007 USD la hora.</p>

<p>Les recomiendo que al momento de crear el droplet, lo <a href="https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/" target="_blank">asocien con una llave SSH</a>.</p>

<p>Este <a href="https://www.digitalocean.com/docs/droplets/how-to/create/" target="_blank">link</a> muestra como crear un droplet en DigitalOcean.</p>

<h3 id="iniciando-sesi√≥n-por-ssh">Iniciando sesi√≥n por SSH</h3>

<!-- TODO: Make a post for cloudinit on digitalocean -->

<p>Por defecto DigitalOcean permite por defecto acceder a los servidores con usuario <code>root</code> lo cual es considerado una <a href="https://unix.stackexchange.com/questions/82626/why-is-root-login-via-ssh-so-bad-that-everyone-advises-to-disable-it" target="_blank">mala pr√°ctica en t√©rminos de seguridad</a>, para un servidor real les recomiendo deshabilitar el login para el usuario root.</p>

<p>Para poder iniciar sesi√≥n, la forma de hacerlo es en el siguiente formato:</p>

<pre><code>$ ssh usuario@servidor
</code></pre>

<p>Para el caso de DigitalOcean ser√≠a:</p>

<pre><code>$ ssh root@ip_droplet
</code></pre>

<p>Una vez conectados al servidor remoto podemos hacer distintas cosas: ejecutar comandos, configurarlo, instalar/desinstalar paquetes, etc. Ya con esto podemos comenzar a jugar un poco con algunas de las cosas divertidas que podemos hacer con SSH.</p>

<h3 id="local-port-forwarding">Local Port Forwarding</h3>

<p>Explicar√© el concepto mediante un ejemplo: imaginemos que se tiene un servidor p√∫blico y detr√°s de este existe una red privada donde pueden haber servidores de base de datos, servicios disponibles solo en la red privada, etc. Entonces al estar estos en una red privada no hay una forma directa de acceder a ellos desde internet. Algunas opciones para poder acceder a servicios detr√°s de una red privada es utilizando una VPN o utilizar Local Port Forwading. Local Port Forwarding nos permite crear un t√∫nel entre un servicio privado con nuestra m√°quina a trav√©s de un servidor p√∫blico.</p>

<p>Veamos la siguiente configuraci√≥n:</p>

<p><img src="https://blog.donkeysharp.xyz/img/ssh_guide_1.png" alt="" /></p>

<p>En la imagen vemos que existe un servidor de base de datos MySQL en una red privada con la direcci√≥n IP <code>10.100.1.23</code> y puerto <code>3306</code> y existe un servidor p√∫blico con la direcci√≥n IP <code>152.190.23.56</code>.</p>

<p>Si desearamos acceder a este servidor de base de datos tendr√≠amos que estar dentro de la red privada lo cual no es cierto ya que nosotros estamos en la red local (privada) de nuestra casa, universidad, trabajo, etc. Por suerte el servidor <code>152.190.23.56</code> tiene acceso a esta red privada adem√°s de poder acceder a este desde internet.</p>

<p>Lo que haremos es utilizar la caracter√≠stica de Local Port Forwarding de OpenSSH para crear un canal seguro por medio del servidor p√∫blico <code>152.190.23.56</code> entre el puerto <code>3306</code> de mi m√°quina local (PC o laptop) hacia el puerto <code>3306</code> del servidor privado de base de datos <code>10.100.1.23</code>.</p>

<p>El formato de ejecuci√≥n es el siguiente:</p>

<pre><code>ssh -nNT -L puertoA:host_privado:puertoB usuario@servidor
</code></pre>

<p>Donde:</p>

<ul>
<li><code>-n</code> evita leer desde STDIN o leer la escritura por l√≠nea de comandos</li>
<li><code>-N</code> no ejecutar un comando remoto</li>
<li><code>-T</code> deshabilitar la opci√≥n de mostrar una terminal</li>
<li><code>-L</code> indicador de Local Port Forwarding</li>
<li><code>puertoA</code> puerto de nuestra computadora donde ser√° expuesto el servicio remoto (MySQL)</li>
<li><code>host_privado</code> la direcci√≥n IP del host al cual no podemos llegar p√∫blicamente pero si a trav√©s del servidor p√∫blico</li>
<li><code>puertoB</code> puerto TCP del servicio que el <code>host_privado</code> est√° exponiendo</li>
</ul>

<p>En nuestro ejemplo ser√≠a algo similar a:</p>

<pre><code>ssh -nNT -L 3306:10.100.1.23:3306 root@ip_droplet
</code></pre>

<p>Es importante saber que si tuvieramos instalado MySQL en nuestra computadora local habr√≠a un conflicto por el puerto <code>3306</code> entonces como este puede ser cualquier puerto podemos utilizar algo como:</p>

<pre><code>ssh -nNT -L 3307:10.100.1.23:3306 root@ip_droplet
</code></pre>

<p>Ahora imaginemos el caso que en la red local de casa, universidad o trabajo existe gente que desea acceder al servidor de base de datos. La respuesta simple es que ellos podr√≠an aplicar el mismo procedimiento y tener acceso a MySQL desde sus m√°quinas locales.</p>

<p>En el supuesto caso que existiera la restricci√≥n de que ellos no tengan y no deban tener acceso al servidor p√∫blico, una soluci√≥n es que yo exponga el servicio de MySQL en la red local utilizando Local Port Forwarding y otras m√°quinas en mi red local puedan conectarse a mi computadora como si yo estuviera exponiendo un servicio MySQL pero en realidad estoy exponiendo el servicio MySQL que est√° corriendo en una red privada en alg√∫n lugar del mundo.</p>

<p>El diagrama muestra lo que se desea conseguir:</p>

<p><img src="https://blog.donkeysharp.xyz/img/ssh_guide_2.png" alt="" /></p>

<p>Para esto solo adicionamos un peque√±o cambio a la ejecuci√≥n previa y debemos ejecutar en el siguiente formato:</p>

<pre><code>ssh -nNT -L ip_local:puertoA:host_privado:puertoB usuario@servidor
</code></pre>

<p>Donde</p>

<ul>
<li><p><code>ip_local</code> es la direcci√≥n IP de nuestra m√°quina en la red local privada, de no estar seguros cual es esta simplemente podemos poner el valor <code>0.0.0.0</code> para exponer por cualquier interfaz de red.</p>

<pre><code>ssh -nNT -L 192.168.1.100:3306:10.100.1.23:3306 root@ip_droplet
</code></pre></li>
</ul>

<p>De este modo las dem√°s m√°quinas en nuestra red local podr√°n conectarse a <code>192.168.1.100:3306</code> y as√≠ acceder al servicio de MySQL.</p>

<h2 id="reproduciendo-el-ejemplo-en-nuestro-servidor-p√∫blico">Reproduciendo el ejemplo en nuestro servidor p√∫blico</h2>

<p>Una ventaja que MySQL tiene por defecto es el de no exponer su puerto <code>3306</code> a ninguna red por seguridad, es decir, solo est√° disponible localmente. Entonces si instalamos MySQL en nuestro servidor p√∫blico el puerto <code>3306</code> no ser√° expuesto al p√∫blico y este lo podr√≠amos considerar como si estuviera en una &ldquo;red privada&rdquo; y poder aplicar lo aprendido.</p>

<p>En nuestro servidor instalamos MySQL con el siguiente comando:</p>

<pre><code>$ sudo apt install mysql-server
</code></pre>

<p>Ahora lo que haremos es percatarnos que MySQL no expone el puert <code>3306</code> al p√∫blico.</p>

<p>Para ello existen diferentes alternativas:</p>

<h3 id="utilizando-netstat-internamente">Utilizando <code>netstat</code> internamente**</h3>

<p>Verificaremos que existe un socket abierto en el puerto <code>3306</code> pero utilizando la direcci√≥n <code>127.0.0.1</code>, es decir, solo localmente.</p>

<pre><code>$ netstat -tlpn
</code></pre>

<p>Veremos una salida similar a:</p>

<pre><code>Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      2722/mysqld
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      784/sshd
tcp6       0      0 :::22                   :::*                    LISTEN      784/sshd

</code></pre>

<p>Y efectivamente nos percatamos que MySQL esta expuesto solo internamente al ver esto en el resultado anterior: <code>127.0.0.1:3306</code></p>

<h3 id="utilizando-nmap-externamente">Utilizando <code>nmap</code> externamente**</h3>

<p>Para poder ver desde cualquier otro lado si el puerto <code>3306</code> esta expuesto al p√∫blico utilizamos la herramienta <a href="https://nmap.org/" target="_blank">nmap</a>:</p>

<pre><code>$ nmap -Pn ip_servidor -p 3306
</code></pre>

<p>Esperamos una respuesta similar a la siguiente:</p>

<pre><code>Starting Nmap 7.40 ( https://nmap.org ) at 2018-08-18 23:24 -04
Nmap scan report for 142.93.204.171
Host is up (0.12s latency).
PORT     STATE  SERVICE
3306/tcp closed mysql
</code></pre>

<p><code>3306/tcp closed mysql</code> indica que no podemos acceder desde afuera al puerto <code>3306</code> en nuestro servidor.</p>

<h3 id="aplicando-local-port-forwarding">Aplicando Local Port Forwarding</h3>

<p>Ahora nos preguntamos ¬øC√≥mo acceder desde afuera a MySQL?. Existen varias respuestas para esa pregunta pero en este post utilizaremos SSH con Local Port Forwarding para mapear un puerto local (nuestra PC o laptop) con un puerto que es accesible internamente dentro del servidor.</p>

<pre><code>ssh -nNT -L 3306:localhost:3306 root@ip_servidor
</code></pre>

<p>De este modo si verificamos en nuestra PC o laptop, el puerto <code>3306</code> deber√≠a estar abierto y apuntando a trav√©s de un t√∫nel SSH al puerto <code>3306</code> disponible solo internamente.</p>

<p>Para verificar, ejecutamos lo siguiente en nuestro dispositivo local:</p>

<pre><code>$ netstat -tlpn
</code></pre>

<p>Esperando una salida similar a:</p>

<pre><code>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      23193/ssh
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
</code></pre>

<p>Donde <code>127.0.0.1:3306</code> nos indica que efectivamente <code>3306</code> localmente est√° abierto y se conecta a trav√©s de un canal seguro a MySQL instalado en el servidor que solo pod√≠a ser accedido internamente.</p>

<p>Algo m√°s para completar esta secci√≥n es permitir a m√°quinas en nuestra red local acceder al puerto <code>3306</code> que a su vez esta mapeado por un canal seguro con MySQL instalado en el servidor. Para ello solo adicionamos un par√°metro extra a nuestro t√∫nel SSH.</p>

<pre><code>$ ssh -nNT -L 192.168.1.100:3306:localhost:3306 root@ip_servidor
</code></pre>

<p>Y al ejecutar netstat localmente veremos algo como:</p>

<pre><code>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 192.1681.1.100:3306     0.0.0.0:*               LISTEN      23193/ssh
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
</code></pre>

<h2 id="comentarios-finales">Comentarios Finales</h2>

<p>En esta primera parte vimos como exponer en nuestra m√°quina local o red local un servicio que se encuentra disponible en una red privada en un datacenter en otro lado del mundo utilizando Local Port Forwarding.</p>

<p>Personalmente yo utilizo esta t√©cnica bastante para acceder a base de datos o cualquier otro servicio interno en una nube privada en caso de no existir una VPN, lo cual facilita bastante el trabajo y nos evita tener que exponer puertos de servicios que no deben ser p√∫blicos.</p>

<p>En la segunda parte de esta serie de entradas, veremos como utilizar SSH para publicar servicios en nuestra m√°quina local a internet mediante un servidor p√∫blico.</p>

                <br>
		<p class="back-to-posts"><a href="https://blog.donkeysharp.xyz/blog/">Ver entradas</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112385104-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

