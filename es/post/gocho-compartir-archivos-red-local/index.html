<!DOCTYPE html>
<html lang="es" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Gocho, Compartir Archivos En Una Red Local | Donkeysharp</title>
<meta name="keywords" content="">
<meta name="description" content="Holas, durante mi tiempo libre estuve trabajando en un proyecto llamado Gocho. Esta peque√±a aplicaci√≥n permite compartir archivos en una red local, por ejemplo la red de la casa, red del trabajo, etc. con la caracter√≠stica de auto-descubrimiento de nodos (auto-discovery). En este post explicar√© de que se trata, por qu√© lo hice y algunos de los retos que surgieron al hacer la aplicaci√≥n.

Por qu√© lo hice?
Lo hice porque deseaba una aplicaci√≥n donde pueda compartir un directorio; poder aguantar varias descargas al mismo tiempo; no tener que preguntar la direcci√≥n IP o puerto de los recursos que otros comparten; tener algo que sea simple de ejecutar en cualquier sistema operativo (Windows, OSX, GNU/Linux) sin tener que instalar ning√∫n requisito previo.">
<meta name="author" content="donkeysharp">
<link rel="canonical" href="https://blog.donkeysharp.xyz/es/post/gocho-compartir-archivos-red-local/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5e527a53ba71ca5f4055f7a87232df40d551cf0ad74e23ec98a5c1e9587fbaf9.css" integrity="sha256-XlJ6U7pxyl9AVfeocjLfQNVRzwrXTiPsmKXB6Vh/uvk=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.donkeysharp.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.donkeysharp.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.donkeysharp.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.donkeysharp.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.donkeysharp.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://blog.donkeysharp.xyz/posts/gocho-file-sharing/">
<link rel="alternate" hreflang="es" href="https://blog.donkeysharp.xyz/es/post/gocho-compartir-archivos-red-local/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="https://blog.donkeysharp.xyz/es/post/gocho-compartir-archivos-red-local/">
  <meta property="og:site_name" content="Donkeysharp">
  <meta property="og:title" content="Gocho, Compartir Archivos En Una Red Local">
  <meta property="og:description" content="Holas, durante mi tiempo libre estuve trabajando en un proyecto llamado Gocho. Esta peque√±a aplicaci√≥n permite compartir archivos en una red local, por ejemplo la red de la casa, red del trabajo, etc. con la caracter√≠stica de auto-descubrimiento de nodos (auto-discovery). En este post explicar√© de que se trata, por qu√© lo hice y algunos de los retos que surgieron al hacer la aplicaci√≥n.
Por qu√© lo hice? Lo hice porque deseaba una aplicaci√≥n donde pueda compartir un directorio; poder aguantar varias descargas al mismo tiempo; no tener que preguntar la direcci√≥n IP o puerto de los recursos que otros comparten; tener algo que sea simple de ejecutar en cualquier sistema operativo (Windows, OSX, GNU/Linux) sin tener que instalar ning√∫n requisito previo.">
  <meta property="og:locale" content="es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-03-29T22:22:46-04:00">
    <meta property="article:modified_time" content="2018-03-29T22:22:46-04:00">
      <meta property="og:image" content="https://blog.donkeysharp.xyz/images/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.donkeysharp.xyz/images/papermod-cover.png">
<meta name="twitter:title" content="Gocho, Compartir Archivos En Una Red Local">
<meta name="twitter:description" content="Holas, durante mi tiempo libre estuve trabajando en un proyecto llamado Gocho. Esta peque√±a aplicaci√≥n permite compartir archivos en una red local, por ejemplo la red de la casa, red del trabajo, etc. con la caracter√≠stica de auto-descubrimiento de nodos (auto-discovery). En este post explicar√© de que se trata, por qu√© lo hice y algunos de los retos que surgieron al hacer la aplicaci√≥n.

Por qu√© lo hice?
Lo hice porque deseaba una aplicaci√≥n donde pueda compartir un directorio; poder aguantar varias descargas al mismo tiempo; no tener que preguntar la direcci√≥n IP o puerto de los recursos que otros comparten; tener algo que sea simple de ejecutar en cualquier sistema operativo (Windows, OSX, GNU/Linux) sin tener que instalar ning√∫n requisito previo.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.donkeysharp.xyz/es/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Gocho, Compartir Archivos En Una Red Local",
      "item": "https://blog.donkeysharp.xyz/es/post/gocho-compartir-archivos-red-local/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gocho, Compartir Archivos En Una Red Local",
  "name": "Gocho, Compartir Archivos En Una Red Local",
  "description": "Holas, durante mi tiempo libre estuve trabajando en un proyecto llamado Gocho. Esta peque√±a aplicaci√≥n permite compartir archivos en una red local, por ejemplo la red de la casa, red del trabajo, etc. con la caracter√≠stica de auto-descubrimiento de nodos (auto-discovery). En este post explicar√© de que se trata, por qu√© lo hice y algunos de los retos que surgieron al hacer la aplicaci√≥n.\nPor qu√© lo hice? Lo hice porque deseaba una aplicaci√≥n donde pueda compartir un directorio; poder aguantar varias descargas al mismo tiempo; no tener que preguntar la direcci√≥n IP o puerto de los recursos que otros comparten; tener algo que sea simple de ejecutar en cualquier sistema operativo (Windows, OSX, GNU/Linux) sin tener que instalar ning√∫n requisito previo.\n",
  "keywords": [
    
  ],
  "articleBody": "Holas, durante mi tiempo libre estuve trabajando en un proyecto llamado Gocho. Esta peque√±a aplicaci√≥n permite compartir archivos en una red local, por ejemplo la red de la casa, red del trabajo, etc. con la caracter√≠stica de auto-descubrimiento de nodos (auto-discovery). En este post explicar√© de que se trata, por qu√© lo hice y algunos de los retos que surgieron al hacer la aplicaci√≥n.\nPor qu√© lo hice? Lo hice porque deseaba una aplicaci√≥n donde pueda compartir un directorio; poder aguantar varias descargas al mismo tiempo; no tener que preguntar la direcci√≥n IP o puerto de los recursos que otros comparten; tener algo que sea simple de ejecutar en cualquier sistema operativo (Windows, OSX, GNU/Linux) sin tener que instalar ning√∫n requisito previo.\nEste tipo de proyectos siempre los hago a modo de aprender algo nuevo. En este caso ya desde el a√±o pasado (2017) ten√≠a ganas de hacer algo con Go. Si bien hice uno que otro experimento a modo de aprender (Golondrina; EazyPanel), esta aplicaci√≥n me pareci√≥ un buen caso de uso para este lenguaje en espec√≠fico (lo elaboro m√°s adelante).\nPor qu√© Go? Si alguien ya ejecut√≥ la aplicaci√≥n es f√°cil notar que no es algo de otro mundo. Gocho podr√≠a haber sido desarrollado en otros lenguajes como: C/C++, Python, Ruby, Java, CSharp, etc. pero ten√≠a algunas observaciones preliminares:\nPython/Ruby - es importante tener los int√©rpretes instalados, en Windows no vienen por defecto. Java/CSharp - es importante tener las m√°quinas virtuales respectivas instaladas (JVM o NetCore). No siempre se d√° el caso que ya venga instalado por defecto en el sistema operativo. C/C++ - ser√≠a la opci√≥n m√°s obvia, pero un par de problemas que encontr√© ser√≠a que por defecto son din√°micamente enlazados, lo cual causar√≠a en alg√∫n caso la instalaci√≥n de librerias necesarias (a menos que use el flag de est√°ticamente enlazados) y el segundo problema es que a pesar que se leer C/C++ no me siento en la confianza de lanzarme a hacer algo Go - est√°ticamente compilado por defecto (todo en un binario), el binario resultante no require que exista la instalaci√≥n previa de alguna librer√≠a, int√©rprete, m√°quina virtual y otros. Con esta lista ‚Äîun poco parcializada üòâ‚Äî Go cumple con las necesidades que tengo.\nAlgo no mencionado es la facilidad con la que puedo crear binarios para diferentes plataformas. Por ejemplo Gocho esta disponible para distintas plataformas sin mucho problema. Releases Gocho\nAlgunos Problemas que Encontr√© Problema 1: Compartir Archivos En la empresa donde trabajo existe una diversidad en cuesti√≥n a sistemas operativos. Algun@s compa√±er@s utilizan Windows, OSX y otr@s GNU/Linux. Para compartir archivo, existe un Active Directory o algo similar configurado, personalmente nunca logr√© acceder a las carpetas compartidas por otros (uso GNU/Linux). Al intentar acceder me sal√≠a la opci√≥n de insertar un dominio y credenciales; p√©se a que introduc√≠a los datos ‚Äîque en teor√≠a eran correctos‚Äî no lograba acceder a los archivos compartidos.\nEn el trabajo hay compa√±eros que comparten informaci√≥n por ejemplo videos, cursos, etc. montando un servidor httpd en su m√°quina local o en mi caso ejecutaba python -m SimpleHTTPServer en el directorio que deseaba compartir. Not√© un problema con SimpleHTTPServer, con pocas personas tratando de descargar el mismo archivo, esta peque√±a utilidad solo permite manejar una descarga al mismo tiempo.\nMi segundo intento fue utilizar algo un poco m√°s robusto que SimpleHTTPServer pero sin la necesidad de levantar algo grande como httpd. Tuve la suerte de chocar con un ejemplo en la documentaci√≥n de Go para el modulo net/http que justamente ‚Äîcon pocas l√≠neas de c√≥digo‚Äî me permit√≠a compartir un directorio y pod√≠a soportar varias descargas simult√°neas sin problemas.\npackage main import ( \"log\" \"net/http\" ) func main() { // Simple static webserver: directory := \"some/directory\" log.Fatal(http.ListenAndServe(\":8080\", http.FileServer(http.Dir(\"/home/myuser/some/directory\")))) } Solo tuve que compilar este archivo; poner el binario que llam√© http en alg√∫n directorio que se encuentre en mi PATH de ejecuci√≥n y voila! ya contaba con algo m√°s robusto que pueda aguantar m√°s descargas y no tenga que montar todo un servicio.\nya contaba con algo m√°s robusto que pueda aguantar m√°s descargas\nCon esto me refiero a algo que aguante varias conexiones simult√°neas, algo que Go lo plantea de una manera simple y en el caso del m√≥dulo net/http ya viene por defecto.\nHasta este punto, solamente tengo un peque√±o binario que me permite compartir un directorio y pueda aguantar varias descargas simult√°neas ‚Äîalgo no tan complejo como montar un servicio httpd pero m√°s robusto que SimpleHTTPServer de Python.\nLa verdad si compilara este binario http para varios sistemas operativos ser√≠a suficiente para compartir archivos, pero quer√≠a ir un poco m√°s alla.\nProblema 2: Indicar Donde se Encuentran los Archivos Compartidos Otro problema que encontr√© es que cada vez que un usuario comparte algo en una red local, este debe ‚Äîde alg√∫n modo‚Äî comunicar como acceder a los recursos que se comparten. Una forma com√∫n de realizar esto es compartir la url de descarga http://ip_red_local:algun_puerto en algun grupo de chat o similar.\nYa que esta aplicaci√≥n la tengo orientada para el contexto de una red local, algo que se me pas√≥ por la cabeza son los juegos en red como StarCraft. En StarCraft cuando alguien crea una partida de red de √°rea local, los jugadores que se unir√°n a una partida no especifican como tal la direcci√≥n IP de la m√°quina servidor a la que se conectar√°n. El juego simplemente muestra las partidas creadas en la red actualmente y uno puede conectarse sin problemas de forma autom√°tica.\nInvestigando un poco sobre c√≥mo estos juegos hacian posible mostrar las partidas ya existentes en la red sin tener que especificar una direcci√≥n IP o algo similar, me llev√≥ al concepto de multicast.\nEn palabras simples, Multicast es un m√©todo que permite enviar informaci√≥n a nodos interesados en una red.\nPor ejemplo, si deseo enviar el mensaje ‚Äúhola mundo‚Äù a computadoras interesadas en recibir este mensaje sin que yo tenga que saber a qu√© m√°quinas espec√≠ficamente, la idea ser√≠a la siguiente:\nMi Computadora: Enviar datagrama UDP con mensaje ‚Äúhola mundo‚Äù a alguna direcci√≥n IP reservada para multicast ej. 239.6.6.6:1234 Computadora Interesada 1: Escuchar por datagramas UDP en 239.6.6.6:1234 Computadora Interesada 2: Escuchar por datagramas UDP en 239.6.6.6:1234 Computadora Interesada n: Escuchar por datagramas UDP en 239.6.6.6:1234 De este modo multicast permite que cualquier m√°quina que desee compartir algo, solo debe enviar su informaci√≥n de nodo (identificador, direcci√≥n IP, puerto) por multicast y otras m√°quinas interesadas.\nSabiendo esto, Gocho adem√°s de compartir un directorio podr√° saber lo que otros nodos Gocho estan compartiendo.\nYa viendo un poco la implementaci√≥n de esto, podemos ver algunos trozos de c√≥digo que utilic√© en Gocho.\npkg/node/net.go\nLa funci√≥n announceNode b√°sicamente env√≠a un paquete multicast.\nfunc announceNode(nodeInfo *NodeInfo) { address, err := net.ResolveUDPAddr(\"udp\", MULTICAST_ADDRESS) // error handling conn, err := net.DialUDP(\"udp\", nil, address) // error handling for { ... conn.Write([]byte(message)) time.Sleep(ANNOUNCE_INTERVAL_SEC * time.Second) } } La funci√≥n listenForNodes que escucha los mensajes multicast.\nfunc listenForNodes(nodeList *list.List) { address, err := net.ResolveUDPAddr(\"udp\", MULTICAST_ADDRESS) // error handling conn, err := net.ListenMulticastUDP(\"udp\", nil, address) // error handling conn.SetReadBuffer(MULTICAST_BUFFER_SIZE) for { packet := make([]byte, MULTICAST_BUFFER_SIZE) size, udpAddr, err := conn.ReadFromUDP(packet) ... } } Entonces gran parte de la ‚Äúm√°gia‚Äù de Gocho se encuentra en el trabajo con multicast. Con multicast una m√°quina puede anunciarse a s√≠ misma y a la vez descubrir a otros nodos.\nProblema 3: Formato de los Mensajes Si bien ya tenemos una forma de comunicarnos entre nodos, v√≠ conveniente poder identificar los paquetes que env√≠a Gocho con otros. B√°sicamente el paquete (en esta versi√≥n inicial) debe seguir lo siguiente:\nLos primeros 4 bytes deben ser 0x60, 0x0d, 0xf0, 0x0d o 0x600df00d, que es la cabecera que identifica que lo enviado es un mensaje de otro nodo de Gocho El siguiente byte especifica el comando, actualmente solo existe un solo comando que es 0x01 que indica que un nodo se esta anunciando. La informaci√≥n del nodo se encuentra en el payload Finalmente el resto es el payload. Para esto decid√≠ utilizar el formato JSON Un hexdump de un mensaje en el que se anuncia un nodo luce de la siguiente forma:\n00000000 60 0d f0 0d 01 7b 22 6e 6f 64 65 49 64 22 3a 22 |`....{\"nodeId\":\"| 00000010 6e 6f 64 6f 2d 73 65 72 67 69 6f 22 2c 22 69 70 |nodo-sergio\",\"ip| 00000020 41 64 64 72 65 73 73 22 3a 22 22 2c 22 77 65 62 |Address\":\"\",\"web| 00000030 50 6f 72 74 22 3a 22 35 30 30 30 22 7d |Port\":\"5000\"}| La decisi√≥n de tener este formato fue la de ahorrar la mayor cantidad de bytes posibles. De hecho, si no utilizara el formato JSON se ahorrar√≠an unos cuantos bytes m√°s.\nEn el futuro es posible que existan m√°s comandos diferentes al de anunciar un nodo (0x01). Es por eso que se dej√≥ un byte reservado para ello.\nDise√±o de la aplicaci√≥n Esta secci√≥n habla un poco m√°s de la implementaci√≥n ya habiendo conocido los problemas mencionados arriba. Para poder seguir esta secci√≥n hago referencia al c√≥digo fuente de la aplicaci√≥n.\nEstructura del C√≥digo La estructura de c√≥digo del proyecto Gocho est√° basada en este art√≠culo en el que se plantea una esctructura para proyectos en Go. Esta estructura es bastante utilizada en diferentes proyectos, entre ellos algunos proyectos bastante conocidos como Kubernetes o Docker.\nEl proyecto incluye un archivo Makefile el cual indica los pasos necesarios para poder construir o desarrollar el proyecto, como tambi√©n crear los binarios para las plataformas soportadas.\nComponentes del Servicio En el anterior punto mencion√© la estructura de c√≥digo que utilizo. En este punto me enforcar√© en los componentes dentro del directorio pkg, especialmente en pkg/node.\nComponente Descripci√≥n pkg/info Informaci√≥n b√°sica de la aplicaci√≥n como nombre o versi√≥n. pkg/cmds Toda la l√≥gica de flags de la utilidad de l√≠nea de comandos. Por ejemplo gocho start [options] o gocho configure. pkg/config Todo el c√≥digo con la l√≥gica y estructuras necesarias para representar la l√≥gica de Gocho. Aca se encuentra la l√≥gica de establecer valores por defecto o cargar las diferentes configuraciones de un archivo .gocho.conf o de los options establecidos por l√≠nea de comandos. pkg/node La l√≥gica principal de la aplicaci√≥n radica en este directorio. El c√≥mo se tiene un dashboard web embebido; el formato de los paquetes; el mecanismo de auto-discovery (multicast) y el √≠ndice de archivos que muestra el contenido del directorio compartido. Algunas Estructuras de Datos y L√≥gica Utilizada La aplicaci√≥n debe guardar la informaci√≥n de otros nodos, para esto decid√≠ hacer uso de una lista enlazada por la simplicidad al borrar o insertar elementos.\nEs importante notar que mientras m√°s nodos se anuncien en una red, es posible que partes del c√≥digo (de cualquier nodo) tendr√° que ejecutar las mismas sentencias al mismo tiempo. Para evitar problemas de concurrencia: principalmente en la lista enlazada que guarda informaci√≥n de otros nodos, hice uso de un Mutex con lo cual pude controlar estos comportamientos que podr√≠an llevar a resultados inesperados.\nAlgo importante es notar que existen algunos timeouts por defecto que constantemente verifican la lista enlazada de nodos. B√°sicamente estos timeouts nos permite liberar recursos, cuando un nodo despu√©s de cierto tiempo deja de anunciarse.\nEl Dashboard Para el desarrollo del dashboard de frontent hice uso de React solamente. Tal vez algunos se preguntan ¬øpor qu√© no utilic√© otras librerias como Redux o React-Router?. Pues la respuesta es simple, como el bundle javascript resultante se encuentra embebido en el binario, si tenemos un bundle m√°s grande y pesado, el binario resultante ser√° m√°s grande y pesado.\nLos componentes y el c√≥digo para la UI se encuentra en el directorio ui. Para la estructura quise mantener las cosas cosas simple as√≠ que utilic√© Create React App para este prop√≥sito.\nDe la misma forma para los estilos, si bien podr√≠a haber utilizado un procesador como SASS, decid√≠ mantener los estilos y solo utilizar el est√°ndar por defecto CSS, que como ver√°n en el c√≥digo es un archivo de 184 l√≠neas de c√≥digo.\nPara generar el bundle javascript solo es necesario ejecutar el siguiente comando.\nmake dist Internamente esto utiliza los scripts de Create React App y para poder tener el bundle embebido dentro del binario, hago uso de Go Generate.\nEste archivo tiene un comentario:\npackage main //go:generate go-bindata -o ../../assets/assets_gen.go -pkg assets ../../ui/build/... import ( \"github.com/donkeysharp/gocho/pkg/cmds\" \"os\" ) ... donde se especifica donde se encuentra el bundle resultante que ser√° embebido en el binario resultante.\nEl √çndice de Archivos Compartidos Esta fue una de las partes en las que tuve mucha diversi√≥n. Como mencion√© en el Problema 1, Go presenta un ejemplo para poder compartir un directorio. El problema con esto es que no cuenta con estilos, extensibilidad, el directorio .. para poder subir un nivel el directorio.\nPara poder personalizar este c√≥digo ya existente tuve que utilizar Interceptor Pattern y un middleware personalizado para poder adicionar √≠conos y HTML personalizados, el directorio .. para ir un nivel hacia arriba y agrupar directorios de archivos de forma ordenada.\nToda la l√≥gica para la personalizaci√≥n de net/http.FileServer se encuentra en el archivo index.go.\nEspero poder crear otra entrada en la que muestro espec√≠ficamente la implementaci√≥n de esta parte que puede ser reutilizada con cualquier otra aplicaci√≥n.\nComentarios Finales Hay varias cosas que deseo mejorar de Gocho. Al ser un proyecto open-source sientanse libres de abrir un issue o mejor contribuir con algo de c√≥digo (bugfixing, nuevos features, documentaci√≥n, etc.)\nEsta es la primera vez que trabajo en una aplicaci√≥n, la cual envia y recibe informaci√≥n de varias m√°quinas o nodos al mismo tiempo y hayan diferentes cosas que sincronizar. Personalmente fue ‚Äîy espero siga siendo‚Äî una experiencia educativa.\n",
  "wordCount" : "2265",
  "inLanguage": "es",
  "image": "https://blog.donkeysharp.xyz/images/papermod-cover.png","datePublished": "2018-03-29T22:22:46-04:00",
  "dateModified": "2018-03-29T22:22:46-04:00",
  "author":{
    "@type": "Person",
    "name": "donkeysharp"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.donkeysharp.xyz/es/post/gocho-compartir-archivos-red-local/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Donkeysharp",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.donkeysharp.xyz/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.donkeysharp.xyz/es/" accesskey="h" title="Donkeysharp (Alt + H)">Donkeysharp</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://blog.donkeysharp.xyz/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.donkeysharp.xyz/es/archive" title="Archivo">
                    <span>Archivo</span>
                </a>
            </li>
            <li>
                <a href="https://blog.donkeysharp.xyz/es/about/" title="Sobre m√≠">
                    <span>Sobre m√≠</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.donkeysharp.xyz/es/">Inicio</a>&nbsp;¬ª&nbsp;<a href="https://blog.donkeysharp.xyz/es/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Gocho, Compartir Archivos En Una Red Local
    </h1>
    <div class="post-meta"><span title='2018-03-29 22:22:46 -0400 -04'>marzo 29, 2018</span>&nbsp;¬∑&nbsp;11 min&nbsp;¬∑&nbsp;donkeysharp&nbsp;|&nbsp;Traducciones:
<ul class="i18n_list">
    <li>
        <a href="https://blog.donkeysharp.xyz/posts/gocho-file-sharing/">English</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Tabla de Contenidos</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#por-qu%c3%a9-lo-hice" aria-label="Por qu√© lo hice?">Por qu√© lo hice?</a></li>
                <li>
                    <a href="#por-qu%c3%a9-go" aria-label="Por qu√© Go?">Por qu√© Go?</a></li>
                <li>
                    <a href="#algunos-problemas-que-encontr%c3%a9" aria-label="Algunos Problemas que Encontr√©">Algunos Problemas que Encontr√©</a><ul>
                        
                <li>
                    <a href="#problema-1-compartir-archivos" aria-label="Problema 1: Compartir Archivos">Problema 1: Compartir Archivos</a></li>
                <li>
                    <a href="#problema-2-indicar-donde-se-encuentran-los-archivos-compartidos" aria-label="Problema 2: Indicar Donde se Encuentran los Archivos Compartidos">Problema 2: Indicar Donde se Encuentran los Archivos Compartidos</a></li>
                <li>
                    <a href="#problema-3-formato-de-los-mensajes" aria-label="Problema 3: Formato de los Mensajes">Problema 3: Formato de los Mensajes</a></li></ul>
                </li>
                <li>
                    <a href="#dise%c3%b1o-de-la-aplicaci%c3%b3n" aria-label="Dise√±o de la aplicaci√≥n">Dise√±o de la aplicaci√≥n</a><ul>
                        
                <li>
                    <a href="#estructura-del-c%c3%b3digo" aria-label="Estructura del C√≥digo">Estructura del C√≥digo</a></li>
                <li>
                    <a href="#componentes-del-servicio" aria-label="Componentes del Servicio">Componentes del Servicio</a></li>
                <li>
                    <a href="#algunas-estructuras-de-datos-y-l%c3%b3gica-utilizada" aria-label="Algunas Estructuras de Datos y L√≥gica Utilizada">Algunas Estructuras de Datos y L√≥gica Utilizada</a></li>
                <li>
                    <a href="#el-dashboard" aria-label="El Dashboard">El Dashboard</a></li>
                <li>
                    <a href="#el-%c3%adndice-de-archivos-compartidos" aria-label="El √çndice de Archivos Compartidos">El √çndice de Archivos Compartidos</a></li></ul>
                </li>
                <li>
                    <a href="#comentarios-finales" aria-label="Comentarios Finales">Comentarios Finales</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Holas, durante mi tiempo libre estuve trabajando en un proyecto llamado <a href="https://github.com/donkeysharp/gocho">Gocho</a>. Esta peque√±a aplicaci√≥n permite compartir archivos en una red local, por ejemplo la red de la casa, red del trabajo, etc. con la caracter√≠stica de auto-descubrimiento de nodos (auto-discovery). En este post explicar√© de que se trata, por qu√© lo hice y algunos de los retos que surgieron al hacer la aplicaci√≥n.</p>
<p><img loading="lazy" src="/img/gocho-dashboard.gif"></p>
<h2 id="por-qu√©-lo-hice">Por qu√© lo hice?<a hidden class="anchor" aria-hidden="true" href="#por-qu√©-lo-hice">#</a></h2>
<p>Lo hice porque deseaba una aplicaci√≥n donde pueda compartir un directorio; poder aguantar varias descargas al mismo tiempo; no tener que preguntar la direcci√≥n IP o puerto de los recursos que otros comparten; tener algo que sea simple de ejecutar en cualquier sistema operativo (Windows, OSX, GNU/Linux) sin tener que instalar ning√∫n requisito previo.</p>
<p>Este tipo de proyectos siempre los hago a modo de aprender algo nuevo. En este caso ya desde el a√±o pasado (2017) ten√≠a ganas de hacer algo con <a href="https://golang.org/">Go</a>. Si bien hice uno que otro experimento a modo de aprender (<a href="https://github.com/donkeysharp/golondrina">Golondrina</a>; <a href="https://github.com/donkeysharp/eazy-panel">EazyPanel</a>), esta aplicaci√≥n me pareci√≥ un buen caso de uso para este lenguaje en espec√≠fico (lo elaboro m√°s adelante).</p>
<h2 id="por-qu√©-go">Por qu√© Go?<a hidden class="anchor" aria-hidden="true" href="#por-qu√©-go">#</a></h2>
<p>Si alguien ya ejecut√≥ la aplicaci√≥n es f√°cil notar que no es algo de otro mundo. Gocho podr√≠a haber sido desarrollado en otros lenguajes como: C/C++, Python, Ruby, Java, CSharp, etc. pero ten√≠a algunas observaciones preliminares:</p>
<ul>
<li>Python/Ruby - es importante tener los int√©rpretes instalados, en Windows no vienen por defecto.</li>
<li>Java/CSharp - es importante tener las m√°quinas virtuales respectivas instaladas (JVM o NetCore). No siempre se d√° el caso que ya venga instalado por defecto en el sistema operativo.</li>
<li>C/C++ - ser√≠a la opci√≥n m√°s obvia, pero un par de problemas que encontr√© ser√≠a que por defecto son din√°micamente enlazados, lo cual causar√≠a en alg√∫n caso la instalaci√≥n de librerias necesarias (a menos que use el flag de est√°ticamente enlazados) y el segundo problema es que a pesar que se leer C/C++ no me siento en la confianza de lanzarme a hacer algo</li>
<li>Go - est√°ticamente compilado por defecto (todo en un binario), el binario resultante no require que exista la instalaci√≥n previa de alguna librer√≠a, int√©rprete, m√°quina virtual y otros.</li>
</ul>
<p>Con esta lista ‚Äîun poco parcializada &#x1f609;‚Äî Go cumple con las necesidades que tengo.</p>
<p>Algo no mencionado es la facilidad con la que puedo crear binarios para diferentes plataformas. Por ejemplo Gocho esta disponible para distintas plataformas sin mucho problema. <a href="https://github.com/donkeysharp/gocho/releases">Releases Gocho</a></p>
<h2 id="algunos-problemas-que-encontr√©">Algunos Problemas que Encontr√©<a hidden class="anchor" aria-hidden="true" href="#algunos-problemas-que-encontr√©">#</a></h2>
<h3 id="problema-1-compartir-archivos">Problema 1: Compartir Archivos<a hidden class="anchor" aria-hidden="true" href="#problema-1-compartir-archivos">#</a></h3>
<p>En la empresa donde trabajo existe una diversidad en cuesti√≥n a sistemas operativos. Algun@s compa√±er@s utilizan Windows, OSX y otr@s GNU/Linux. Para compartir archivo, existe un Active Directory o algo similar configurado, personalmente nunca logr√© acceder a las carpetas compartidas por otros (uso GNU/Linux). Al intentar acceder me sal√≠a la opci√≥n de insertar un dominio y credenciales; p√©se a que introduc√≠a los datos ‚Äîque en teor√≠a eran correctos‚Äî no lograba acceder a los archivos compartidos.</p>
<p>En el trabajo hay compa√±eros que comparten informaci√≥n por ejemplo videos, cursos, etc. montando un servidor <code>httpd</code> en su m√°quina local o en mi caso ejecutaba <code>python -m SimpleHTTPServer</code> en el directorio que deseaba compartir. Not√© un problema con <code>SimpleHTTPServer</code>, con pocas personas tratando de descargar el mismo archivo, esta peque√±a utilidad solo permite manejar una descarga al mismo tiempo.</p>
<p>Mi segundo intento fue utilizar algo un poco m√°s robusto que <code>SimpleHTTPServer</code> pero sin la necesidad de levantar algo grande como <code>httpd</code>. Tuve la suerte de chocar con un ejemplo en la documentaci√≥n de Go para el modulo <code>net/http</code> que justamente ‚Äîcon pocas l√≠neas de c√≥digo‚Äî me permit√≠a compartir un directorio y pod√≠a soportar varias descargas simult√°neas sin problemas.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Simple static webserver:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">directory</span> <span class="o">:=</span> <span class="s">&#34;some/directory&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;/home/myuser/some/directory&#34;</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Solo tuve que compilar este archivo; poner el binario que llam√© <code>http</code> en alg√∫n directorio que se encuentre en mi <code>PATH</code> de ejecuci√≥n y voila! ya contaba con algo m√°s robusto que pueda aguantar m√°s descargas y no tenga que montar todo un servicio.</p>
<blockquote>
<blockquote>
<p><em>ya contaba con algo m√°s robusto que pueda aguantar m√°s descargas</em></p></blockquote>
<p>Con esto me refiero a algo que aguante varias conexiones simult√°neas, algo que Go lo plantea de una manera simple y en el caso del m√≥dulo <code>net/http</code> ya viene por defecto.</p></blockquote>
<p>Hasta este punto, solamente tengo un peque√±o binario que me permite compartir un directorio y pueda aguantar varias descargas simult√°neas ‚Äîalgo no tan complejo como montar un servicio <code>httpd</code> pero m√°s robusto que <code>SimpleHTTPServer</code> de Python.</p>
<p>La verdad si compilara este binario <code>http</code> para varios sistemas operativos ser√≠a suficiente para compartir archivos, pero quer√≠a ir un poco m√°s alla.</p>
<h3 id="problema-2-indicar-donde-se-encuentran-los-archivos-compartidos">Problema 2: Indicar Donde se Encuentran los Archivos Compartidos<a hidden class="anchor" aria-hidden="true" href="#problema-2-indicar-donde-se-encuentran-los-archivos-compartidos">#</a></h3>
<p>Otro problema que encontr√© es que cada vez que un usuario comparte algo en una red local, este debe ‚Äîde alg√∫n modo‚Äî comunicar como acceder a los recursos que se comparten. Una forma com√∫n de realizar esto es compartir la url de descarga <code>http://ip_red_local:algun_puerto</code> en algun grupo de chat o similar.</p>
<p>Ya que esta aplicaci√≥n la tengo orientada para el contexto de una red local, algo que se me pas√≥ por la cabeza son los juegos en red como StarCraft. En StarCraft cuando alguien crea una partida de red de √°rea local, los jugadores que se unir√°n a una partida no especifican como tal la direcci√≥n IP de la m√°quina servidor a la que se conectar√°n. El juego simplemente muestra las partidas creadas en la red actualmente y uno puede conectarse sin problemas de forma autom√°tica.</p>
<p>Investigando un poco sobre c√≥mo estos juegos hacian posible mostrar las partidas ya existentes en la red sin tener que especificar una direcci√≥n IP o algo similar, me llev√≥ al concepto de <a href="https://en.wikipedia.org/wiki/Multicast">multicast</a>.</p>
<p>En palabras simples, Multicast es un m√©todo que permite enviar informaci√≥n a nodos interesados en una red.</p>
<p>Por ejemplo, si deseo enviar el mensaje &ldquo;hola mundo&rdquo; a computadoras interesadas en recibir este mensaje sin que yo tenga que saber a qu√© m√°quinas espec√≠ficamente, la idea ser√≠a la siguiente:</p>
<ul>
<li><em>Mi Computadora</em>: Enviar datagrama UDP con mensaje &ldquo;hola mundo&rdquo; a alguna <a href="https://en.wikipedia.org/wiki/Multicast_address#IPv4">direcci√≥n IP reservada para multicast</a> ej. 239.6.6.6:1234</li>
<li><em>Computadora Interesada 1</em>: Escuchar por datagramas UDP en 239.6.6.6:1234</li>
<li><em>Computadora Interesada 2</em>: Escuchar por datagramas UDP en 239.6.6.6:1234</li>
<li><em>Computadora Interesada n</em>: Escuchar por datagramas UDP en 239.6.6.6:1234</li>
</ul>
<p>De este modo multicast permite que cualquier m√°quina que desee compartir algo, solo debe enviar su informaci√≥n de nodo (identificador, direcci√≥n IP, puerto) por multicast y otras m√°quinas interesadas.</p>
<p>Sabiendo esto, Gocho adem√°s de compartir un directorio podr√° saber lo que otros nodos Gocho estan compartiendo.</p>
<p>Ya viendo un poco la implementaci√≥n de esto, podemos ver algunos trozos de c√≥digo que utilic√© en Gocho.</p>
<p><a href="https://github.com/donkeysharp/gocho/blob/master/pkg/node/net.go">pkg/node/net.go</a></p>
<p>La funci√≥n <code>announceNode</code> b√°sicamente env√≠a un paquete multicast.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">announceNode</span><span class="p">(</span><span class="nx">nodeInfo</span> <span class="o">*</span><span class="nx">NodeInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">address</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ResolveUDPAddr</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="nx">MULTICAST_ADDRESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// error handling</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">DialUDP</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// error handling</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conn</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">message</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">ANNOUNCE_INTERVAL_SEC</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>La funci√≥n <code>listenForNodes</code> que escucha los mensajes multicast.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">listenForNodes</span><span class="p">(</span><span class="nx">nodeList</span> <span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">address</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ResolveUDPAddr</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="nx">MULTICAST_ADDRESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// error handling</span>
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ListenMulticastUDP</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// error handling</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span><span class="p">.</span><span class="nf">SetReadBuffer</span><span class="p">(</span><span class="nx">MULTICAST_BUFFER_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">packet</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">MULTICAST_BUFFER_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">size</span><span class="p">,</span> <span class="nx">udpAddr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">ReadFromUDP</span><span class="p">(</span><span class="nx">packet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Entonces gran parte de la &ldquo;m√°gia&rdquo; de Gocho se encuentra en el trabajo con multicast. Con multicast una m√°quina puede anunciarse a s√≠ misma y a la vez descubrir a otros nodos.</p>
<h3 id="problema-3-formato-de-los-mensajes">Problema 3: Formato de los Mensajes<a hidden class="anchor" aria-hidden="true" href="#problema-3-formato-de-los-mensajes">#</a></h3>
<p>Si bien ya tenemos una forma de comunicarnos entre nodos, v√≠ conveniente poder identificar los paquetes que env√≠a Gocho con otros. B√°sicamente el paquete (en esta versi√≥n inicial) debe seguir lo siguiente:</p>
<ol>
<li>Los primeros 4 bytes deben ser <code>0x60</code>, <code>0x0d</code>, <code>0xf0</code>, <code>0x0d</code> o <code>0x600df00d</code>, que es la cabecera que identifica que lo enviado es un mensaje de otro nodo de Gocho</li>
<li>El siguiente byte especifica el comando, actualmente solo existe un solo comando que es <code>0x01</code> que indica que un nodo se esta anunciando. La informaci√≥n del nodo se encuentra en el payload</li>
<li>Finalmente el resto es el payload. Para esto decid√≠ utilizar el formato JSON</li>
</ol>
<p>Un hexdump de un mensaje en el que se anuncia un nodo luce de la siguiente forma:</p>
<pre tabindex="0"><code>00000000  60 0d f0 0d 01 7b 22 6e  6f 64 65 49 64 22 3a 22  |`....{&#34;nodeId&#34;:&#34;|
00000010  6e 6f 64 6f 2d 73 65 72  67 69 6f 22 2c 22 69 70  |nodo-sergio&#34;,&#34;ip|
00000020  41 64 64 72 65 73 73 22  3a 22 22 2c 22 77 65 62  |Address&#34;:&#34;&#34;,&#34;web|
00000030  50 6f 72 74 22 3a 22 35  30 30 30 22 7d           |Port&#34;:&#34;5000&#34;}|
</code></pre><p>La decisi√≥n de tener este formato fue la de ahorrar la mayor cantidad de bytes posibles. De hecho, si no utilizara el formato JSON se ahorrar√≠an unos cuantos bytes m√°s.</p>
<p>En el futuro es posible que existan m√°s comandos diferentes al de anunciar un nodo (<code>0x01</code>). Es por eso que se dej√≥ un byte reservado para ello.</p>
<h2 id="dise√±o-de-la-aplicaci√≥n">Dise√±o de la aplicaci√≥n<a hidden class="anchor" aria-hidden="true" href="#dise√±o-de-la-aplicaci√≥n">#</a></h2>
<p>Esta secci√≥n habla un poco m√°s de la implementaci√≥n ya habiendo conocido los problemas mencionados arriba. Para poder seguir esta secci√≥n hago referencia al <a href="https://github.com/donkeysharp/gocho">c√≥digo fuente</a> de la aplicaci√≥n.</p>
<h3 id="estructura-del-c√≥digo">Estructura del C√≥digo<a hidden class="anchor" aria-hidden="true" href="#estructura-del-c√≥digo">#</a></h3>
<p>La estructura de c√≥digo del proyecto Gocho est√° basada en este <a href="https://peter.bourgon.org/go-best-practices-2016/#repository-structure">art√≠culo</a> en el que se plantea una esctructura para proyectos en Go. Esta estructura es bastante utilizada en diferentes proyectos, entre ellos algunos proyectos bastante conocidos como <a href="https://github.com/kubernetes/kubernetes">Kubernetes</a> o <a href="https://github.com/moby/moby">Docker</a>.</p>
<p>El proyecto incluye un archivo <code>Makefile</code> el cual indica los pasos necesarios para poder construir o desarrollar el proyecto, como tambi√©n crear los binarios para las plataformas soportadas.</p>
<h3 id="componentes-del-servicio">Componentes del Servicio<a hidden class="anchor" aria-hidden="true" href="#componentes-del-servicio">#</a></h3>
<p>En el anterior punto mencion√© la estructura de c√≥digo que utilizo. En este punto me enforcar√© en los componentes dentro del directorio <code>pkg</code>, especialmente en <code>pkg/node</code>.</p>
<table>
  <thead>
      <tr>
          <th>Componente</th>
          <th>Descripci√≥n</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>pkg/info</code></td>
          <td>Informaci√≥n b√°sica de la aplicaci√≥n como nombre o versi√≥n.</td>
      </tr>
      <tr>
          <td><code>pkg/cmds</code></td>
          <td>Toda la l√≥gica de flags de la utilidad de l√≠nea de comandos. Por ejemplo <code>gocho start [options]</code> o <code>gocho configure</code>.</td>
      </tr>
      <tr>
          <td><code>pkg/config</code></td>
          <td>Todo el c√≥digo con la l√≥gica y estructuras necesarias para representar la l√≥gica de Gocho. Aca se encuentra la l√≥gica de establecer valores por defecto o cargar las diferentes configuraciones de un archivo <code>.gocho.conf</code> o de los options establecidos por l√≠nea de comandos.</td>
      </tr>
      <tr>
          <td><code>pkg/node</code></td>
          <td>La l√≥gica principal de la aplicaci√≥n radica en este directorio. El c√≥mo se tiene un dashboard web embebido; el formato de los paquetes; el mecanismo de auto-discovery (multicast) y el √≠ndice de archivos que muestra el contenido del directorio compartido.</td>
      </tr>
  </tbody>
</table>
<h3 id="algunas-estructuras-de-datos-y-l√≥gica-utilizada">Algunas Estructuras de Datos y L√≥gica Utilizada<a hidden class="anchor" aria-hidden="true" href="#algunas-estructuras-de-datos-y-l√≥gica-utilizada">#</a></h3>
<p>La aplicaci√≥n debe guardar la informaci√≥n de otros nodos, para esto decid√≠ hacer uso de una lista enlazada por la simplicidad al borrar o insertar elementos.</p>
<p>Es importante notar que mientras m√°s nodos se anuncien en una red, es posible que partes del c√≥digo (de cualquier nodo) tendr√° que ejecutar las mismas sentencias al mismo tiempo. Para evitar problemas de concurrencia: principalmente en la lista enlazada que guarda informaci√≥n de otros nodos, hice uso de un <a href="https://golang.org/pkg/sync/#Mutex">Mutex</a> con lo cual pude controlar estos comportamientos que podr√≠an llevar a resultados inesperados.</p>
<p>Algo importante es notar que existen algunos timeouts por defecto que constantemente verifican la lista enlazada de nodos. B√°sicamente estos timeouts nos permite liberar recursos, cuando un nodo despu√©s de cierto tiempo deja de anunciarse.</p>
<h3 id="el-dashboard">El Dashboard<a hidden class="anchor" aria-hidden="true" href="#el-dashboard">#</a></h3>
<p>Para el desarrollo del dashboard de frontent hice uso de <a href="https://reactjs.org/">React</a> solamente. Tal vez algunos se preguntan ¬øpor qu√© no utilic√© otras librerias como Redux o React-Router?. Pues la respuesta es simple, como el bundle javascript resultante se encuentra embebido en el binario, si tenemos un bundle m√°s grande y pesado, el binario resultante ser√° m√°s grande y pesado.</p>
<p>Los componentes y el c√≥digo para la UI se encuentra en el directorio <code>ui</code>. Para la estructura quise mantener las cosas cosas simple as√≠ que utilic√© <a href="https://github.com/facebook/create-react-app">Create React App</a> para este prop√≥sito.</p>
<p>De la misma forma para los estilos, si bien podr√≠a haber utilizado un procesador como <em>SASS</em>, decid√≠ mantener los estilos y solo utilizar el est√°ndar por defecto <em>CSS</em>, que como ver√°n en el c√≥digo es un <a href="https://github.com/donkeysharp/gocho/blob/master/ui/src/App.css">archivo</a> de 184 l√≠neas de c√≥digo.</p>
<p>Para generar el bundle javascript solo es necesario ejecutar el siguiente comando.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">make dist
</span></span></code></pre></div><p>Internamente esto utiliza los scripts de Create React App y para poder tener el bundle embebido dentro del binario, hago uso de <a href="https://blog.golang.org/generate">Go Generate</a>.</p>
<p><a href="https://github.com/donkeysharp/gocho/blob/master/cmd/gocho/gocho.go">Este archivo</a> tiene un comentario:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:generate go-bindata -o ../../assets/assets_gen.go -pkg assets ../../ui/build/...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/donkeysharp/gocho/pkg/cmds&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></div><p>donde se especifica donde se encuentra el bundle resultante que ser√° embebido en el binario resultante.</p>
<h3 id="el-√≠ndice-de-archivos-compartidos">El √çndice de Archivos Compartidos<a hidden class="anchor" aria-hidden="true" href="#el-√≠ndice-de-archivos-compartidos">#</a></h3>
<p>Esta fue una de las partes en las que tuve mucha diversi√≥n. Como mencion√© en el <em>Problema 1</em>, Go presenta un ejemplo para poder compartir un directorio. El problema con esto es que no cuenta con estilos, extensibilidad, el directorio <code>..</code> para poder subir un nivel el directorio.</p>
<p>Para poder personalizar este c√≥digo ya existente tuve que utilizar <a href="https://en.wikipedia.org/wiki/Interceptor_pattern">Interceptor Pattern</a> y un middleware personalizado para poder adicionar √≠conos y HTML personalizados, el directorio <code>..</code> para ir un nivel hacia arriba y agrupar directorios de archivos de forma ordenada.</p>
<p>Toda la l√≥gica para la personalizaci√≥n de <code>net/http.FileServer</code> se encuentra en el archivo <a href="https://github.com/donkeysharp/gocho/blob/master/pkg/node/index.go">index.go</a>.</p>
<p>Espero poder crear otra entrada en la que muestro espec√≠ficamente la implementaci√≥n de esta parte que puede ser reutilizada con cualquier otra aplicaci√≥n.</p>
<h2 id="comentarios-finales">Comentarios Finales<a hidden class="anchor" aria-hidden="true" href="#comentarios-finales">#</a></h2>
<p>Hay varias cosas que deseo mejorar de <a href="https://github.com/donkeysharp/gocho">Gocho</a>. Al ser un proyecto open-source sientanse libres de abrir un issue o mejor contribuir con algo de c√≥digo (bugfixing, nuevos features, documentaci√≥n, etc.)</p>
<p>Esta es la primera vez que trabajo en una aplicaci√≥n, la cual envia y recibe informaci√≥n de varias m√°quinas o nodos al mismo tiempo y hayan diferentes cosas que sincronizar. Personalmente fue ‚Äîy espero siga siendo‚Äî una experiencia educativa.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.donkeysharp.xyz/es/post/diversion-con-ssh-parte-1/">
    <span class="title">¬´ Anterior</span>
    <br>
    <span>Diversi√≥n con SSH - Local Port Forwarding</span>
  </a>
  <a class="next" href="https://blog.donkeysharp.xyz/es/post/configuracion-de-escritorio-debian/">
    <span class="title">Siguiente ¬ª</span>
    <br>
    <span>Mis Configuraciones De Escritorio en Debian</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on x"
            href="https://x.com/intent/tweet/?text=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local&amp;url=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f&amp;title=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local&amp;summary=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local&amp;source=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f&title=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on whatsapp"
            href="https://api.whatsapp.com/send?text=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local%20-%20https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on telegram"
            href="https://telegram.me/share/url?text=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local&amp;url=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Gocho, Compartir Archivos En Una Red Local on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Gocho%2c%20Compartir%20Archivos%20En%20Una%20Red%20Local&u=https%3a%2f%2fblog.donkeysharp.xyz%2fes%2fpost%2fgocho-compartir-archivos-red-local%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>¬© <a href="https://x.com/donkeysharp">Donkeysharp</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copiar';

        function copyingDone() {
            copybutton.innerHTML = '¬°copiado!';
            setTimeout(() => {
                copybutton.innerHTML = 'copiar';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
